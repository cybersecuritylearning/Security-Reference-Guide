---
description: Where can we go, once we are in?
---

# Active Directory

## **AD Guides and Reference**

![](../../../.gitbook/assets/Pentestingactivedirectory.png)

### Active Directory Basics and Collections

{% embed url="https://docs.microsoft.com/en-us/windows-server/identity/ad-ds/get-started/virtual-dc/active-directory-domain-services-overview" %}

* [https://adsecurity.org/](https://adsecurity.org)
* [https://kvenkatraman10.gitbook.io/ad101/](https://kvenkatraman10.gitbook.io/ad101/)
* [https://activedirectorypro.com/glossary/](https://activedirectorypro.com/glossary/)
* [Infosec\_Reference/Active\_Directory](https://github.com/rmusser01/Infosec\_Reference/blob/master/Draft/Active\_Directory.md)
* [https://github.com/infosecn1nja/AD-Attack-Defense](https://github.com/infosecn1nja/AD-Attack-Defense)
* [AD-security-workshop](https://github.com/wavestone-cdt/AD-security-workshop)
* [https://social.technet.microsoft.com/wiki/contents/articles/20964.active-directory-ultimate-reading-collection.aspx](https://social.technet.microsoft.com/wiki/contents/articles/20964.active-directory-ultimate-reading-collection.aspx)
* [https://xapax.github.io/security/#attacking\_active\_directory\_domain/understanding\_active\_directory/about\_active\_directory/](https://xapax.github.io/security/#attacking\_active\_directory\_domain/understanding\_active\_directory/about\_active\_directory/)

### Domain Controllers

* [https://adsecurity.org/?p=3377](https://adsecurity.org/?p=3377)
* [https://xapax.github.io/security/#attacking\_active\_directory\_domain/understanding\_active\_directory/domain\_controller/](https://xapax.github.io/security/#attacking\_active\_directory\_domain/understanding\_active\_directory/domain\_controller/)
* [Attacking Read-Only Domain Controllers (RODCs) to Own Active Directory](https://adsecurity.org/?p=3592)
* [https://www.secureauth.com/blog/the-kerberos-key-list-attack-the-return-of-the-read-only-domain-controllers/](https://www.secureauth.com/blog/the-kerberos-key-list-attack-the-return-of-the-read-only-domain-controllers/)

### Domain Groups

{% embed url="https://docs.microsoft.com/en-us/windows/security/identity-protection/access-control/active-directory-security-groups" %}

* [https://www.harmj0y.net/blog/activedirectory/a-pentesters-guide-to-group-scoping/](https://www.harmj0y.net/blog/activedirectory/a-pentesters-guide-to-group-scoping/)

### Group Policy

{% embed url="https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/hh831791(v=ws.11)" %}

* [NIST Hardened GPO checklist](https://ncp.nist.gov/checklist/629/download/7296)
* [https://xapax.github.io/security/#attacking\_active\_directory\_domain/understanding\_active\_directory/group\_policies/](https://xapax.github.io/security/#attacking\_active\_directory\_domain/understanding\_active\_directory/group\_policies/)

### Kerberos

{% embed url="https://docs.microsoft.com/en-us/windows-server/security/kerberos/kerberos-authentication-overview" %}

* [https://m0chan.github.io/2019/07/31/How-To-Attack-Kerberos-101.html](https://m0chan.github.io/2019/07/31/How-To-Attack-Kerberos-101.html)
* [https://0xeb-bp.com/blog/2019/11/21/practical-guide-pass-the-ticket.html](https://0xeb-bp.com/blog/2019/11/21/practical-guide-pass-the-ticket.html)
* [https://blog.redforce.io/oh-my-kerberos-do-not-get-kerberoasted/](https://blog.redforce.io/oh-my-kerberos-do-not-get-kerberoasted/)
* [Kerberos Tickets on Linux Red Teams](https://www.fireeye.com/blog/threat-research/2020/04/kerberos-tickets-on-linux-red-teams.html)
* [https://posts.specterops.io/kerberosity-killed-the-domain-an-offensive-kerberos-overview-eb04b1402c61](https://posts.specterops.io/kerberosity-killed-the-domain-an-offensive-kerberos-overview-eb04b1402c61)

### **AD Tips**

* [AD Security Technical Implementation Guide](https://www.stigviewer.com/stig/active\_directory\_domain/)
* [https://xapax.github.io/security/#attacking\_active\_directory\_domain/good\_to\_know/active\_directory\_help\_commands/](https://xapax.github.io/security/#attacking\_active\_directory\_domain/good\_to\_know/active\_directory\_help\_commands/)
* [https://xapax.github.io/security/#attacking\_active\_directory\_domain/active\_directory\_privilege\_escalation/check\_for\_lockout\_threshold/](https://xapax.github.io/security/#attacking\_active\_directory\_domain/active\_directory\_privilege\_escalation/check\_for\_lockout\_threshold/)

### CheatSheets

* [Active-Directory-Exploitation-Cheat-Sheet](https://github.com/S1ckB0y1337/Active-Directory-Exploitation-Cheat-Sheet)
* [Kerberos Attacks Cheat Sheet](https://gist.github.com/TarlogicSecurity/2f221924fef8c14a1d8e29f3cb5c5c4a)
* [Kerberos cheatsheet](https://gist.github.com/knethteo/2fc8af6ea28199fd63a529a73a4176c7)
* [Active Directory Exploitation Cheat Sheet](https://github.com/Integration-IT/Active-Directory-Exploitation-Cheat-Sheet)

### Attacking AD

* [PayloadsAllTheThings/ActiveDirectoryAttack](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Active%20Directory%20Attack.md)
* [PayloadsAllTheThings/Windows-Usingcredentials](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Windows%20-%20Using%20credentials.md)
* [Top 16 Active Directory Vulnerabilities](https://www.infosecmatter.com/top-16-active-directory-vulnerabilities/)
* [Attacking Active Directory: 0 to 0.9 | zer1t0](https://zer1t0.gitlab.io/posts/attacking\_ad/)
* [https://www.blackhillsinfosec.com/domain-goodness-learned-love-ad-explorer/](https://www.blackhillsinfosec.com/domain-goodness-learned-love-ad-explorer/)
* [https://www.blackhillsinfosec.com/webcast-weaponizing-active-directory/](https://www.blackhillsinfosec.com/webcast-weaponizing-active-directory/)
* [https://casvancooten.com/posts/2020/11/windows-active-directory-exploitation-cheat-sheet-and-command-reference/](https://casvancooten.com/posts/2020/11/windows-active-directory-exploitation-cheat-sheet-and-command-reference/)
* [Tactics, Techniques and Procedures for Attacking Active Directory BlackHat Asia 2019](https://docs.google.com/presentation/d/1j2nW05H-iRz7-FVTRh-LBXQm6M6YIBQNWa4V7tp99YQ/)
* [https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse](https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse)
* [WadComs - ](https://wadcoms.github.io/#)WADComs is an interactive cheat sheet, containing a curated list of offensive security tools and their respective commands, to be used against Windows/AD environments.

## **Queries and Commands for Active Directory**

* Get more information about users in AD
  * Manual Queries - Traditional
    * \>net user - enumerates all accounts
    * \>net user /domain - enumerates all accounts in the domain
    * \>net user bob\_admin - enumerate groups the user belongs to
  * Manual queries - Powershell
    * Script that will Enumerate AD users and properties of the accounts
    * \- See PWKv2
* [https://xapax.github.io/security/#attacking\_active\_directory\_domain/recon/active\_directory\_recon/](https://xapax.github.io/security/#attacking\_active\_directory\_domain/recon/active\_directory\_recon/)
* [https://xapax.github.io/security/#attacking\_active\_directory\_domain/powershell/activedirectory/](https://xapax.github.io/security/#attacking\_active\_directory\_domain/powershell/activedirectory/)
* [https://xapax.github.io/security/#attacking\_active\_directory\_domain/good\_to\_know/ldap\_syntax/](https://xapax.github.io/security/#attacking\_active\_directory\_domain/good\_to\_know/ldap\_syntax/)
* [https://xapax.github.io/security/#attacking\_active\_directory\_domain/powershell/jit\_csharp\_compilation/](https://xapax.github.io/security/#attacking\_active\_directory\_domain/powershell/jit\_csharp\_compilation/)
* _Cyber Operations: Active Directory - pg.235_
* _BTFM: Active Directory Inventory - pg. 16_

## **AD Tools**

### [Bloodhound](https://github.com/BloodHoundAD/BloodHound)&#x20;

The Active Directory Mapping tool. Used by Red and Blue teamers to map out their Active Directory environment and look for the shortest path to compromise Domain Admin

* [Bloodhound Enterprise ](https://bloodhoundenterprise.io)- Enterprise grade attack path management solution
* [BloodHound.py](https://github.com/fox-it/BloodHound.py) - A Python based ingestor for BloodHound
* [Plumhound](https://github.com/PlumHound/PlumHound) - Reporting Engine for bloodhound.
* [SharpHound](https://github.com/BloodHoundAD/SharpHound) - C# version of bloodhound
* [GoodHound](https://github.com/idnahacks/GoodHound) - Uses Sharphound, Bloodhound and Neo4j to produce an actionable list of attack paths for targeted remediation.
* [BadBlood](https://github.com/davidprowe/BadBlood) - BadBlood by Secframe fills a Microsoft Active Directory Domain with a structure and thousands of objects. The output of the tool is a domain similar to a domain in the real world. Used for testing of Bloodhound.
* [aclpwn.py](https://github.com/fox-it/aclpwn.py) - Active Directory ACL exploitation with BloodHound
* [crackhound](https://github.com/trustedsec/crackhound) - CrackHound is a way to introduce plain-text passwords into BloodHound. This allows you to upload all your cracked hashes to the Neo4j database and use it for reporting purposes (csv exports) or path finding in BloodHound using custom queries.
  * [https://www.trustedsec.com/blog/expanding-the-hound-introducing-plaintext-field-to-compromised-accounts/](https://www.trustedsec.com/blog/expanding-the-hound-introducing-plaintext-field-to-compromised-accounts/)
* ****[**GoldenCopy**](https://github.com/Dramelac/GoldenCopy) **-** Copy the properties and groups of a user from neo4j (bloodhound) to create an identical golden ticket.
* Bloodhound Guides and Reference
  * [Awesome Lists Collection: Bloodhound](https://github.com/chryzsh/awesome-bloodhound)
  * [BloodHound: Six Degrees of Domain Admin â€” BloodHound 3.0.3 documentation](https://bloodhound.readthedocs.io/en/latest/)&#x20;
  * [Title - ERNW\_DogWhispererHandbook.pdf](https://ernw.de/download/BloodHoundWorkshop/ERNW\_DogWhispererHandbook.pdf)&#x20;
  * [BloodHound Power Usage - Google Slides](https://docs.google.com/presentation/d/1-fJooJ\_ehGnyrJUHj8G2sGMmSNuYs60P2JWEKnspxng/mobilepresent#slide=id.g35f391192\_00)&#x20;
  * [CptJesus | BloodHound: Intro to Cypher](https://blog.cptjesus.com/posts/introtocypher)&#x20;
  * [AD Resilience - Oslo 2019 - Google Slides](https://docs.google.com/presentation/d/1RmewetR6mp4ZzDlgPL4wRUmePmEtXUXOWw7ArJ5JGOY/mobilepresent#slide=id.g35f391192\_00)
  * [Attack Mapping With Bloodhound](https://blog.stealthbits.com/local-admin-mapping-bloodhound)
  * [Hidden Administrative Accounts: BloodHound to the Rescue](https://www.crowdstrike.com/blog/hidden-administrative-accounts-bloodhound-to-the-rescue/)
  * [Bloodhound walkthrough. A Tool for Many Tradecrafts](https://www.pentestpartners.com/security-blog/bloodhound-walkthrough-a-tool-for-many-tradecrafts/)
  * [Conda's Bloodhound Setup Video](https://www.youtube.com/watch?v=aJqjH3MsbLM\&list=PLDrNMcTNhhYqZj7WZt2GfNhBDqBnhW6AT\&index=3)
* Cypher Queries
  * [DogWhisperer - BloodHound Cypher Cheat Sheet (v2)](https://github.com/SadProcessor/Cheats/blob/master/DogWhispererV2.md)
  * [Bloodhound-Custom-Queries](https://github.com/hausec/Bloodhound-Custom-Queries)
  * [BloodhoundAD-Queries](https://github.com/Scoubi/BloodhoundAD-Queries)
  * [Bloodhound Cypher Cheatsheet](https://hausec.com/2019/09/09/bloodhound-cypher-cheatsheet/)
* _Operator Handbook: Bloodhound - pg. 49_

### Bloodhound Basics

* Uses graph theory to reveal the hidden and unintended relationships in an AD environment.
* Easily identity highly complex attack paths - can be used by defenders ad well.
* Bloodhound works by running an ingestor that queries AD for users, groups and hosts. It will then connect to each system to enumerate logged in users sessions and permissions. \*\*\*WARNING: VERY LOUD\*\*\* There is a stealth option but its limited.
* Two Verisons
  * BloodHound - Powershell based older module&#x20;
  * Sharphound - C# verision that is much faster and stable. Standalone binary or imported as a Powershell script.
    * Script version wil use reflection and assembly.load to load the compiled ingestor into memory
    * &#x20;[https://github.com/BloodhoundAD/BloodHound/tree/master/ingestors](https://github.com/BloodhoundAD/BloodHound/tree/master/ingestors)
* Multiple connection Methods you might need to specify
  * Group - group membership info
  * LocalGroup - Collect local admin info
  * Session - session info
  * SessionLoop - Continuously collection session info until killed
  * Trust - enumerate domain trust data
  * ACL - collect ACL data
  * ComputerOnly - local admin and session data
  * GPOLocalGroup - collects local admin info via group policy objects
  * LoggedOn - Collects session info using privileged methods (needs admin)
  * ObjectProps - collects node property info for users and devices.
  * Default - collects Group membership, local admin,sessions, and domain trusts
* Commands
  * Bloodhound.ps1\[sharphound.ps1] Invoke-Bloodhound -CollectionMethod \[method of choice]
  * \> Sharphound.exe -c \[method of choice]
  * After bloodhound finishes, it will drop the files on the victims system. Pull them on to your machine.
  * Next we need to start our correlation graph using Neo4j server and import the data
    * \# apt-get install bloodhound
    * \# neo4j console
    * Open browser to [http://localhost:7474](http://localhost:7474)
      * connect to bolt://localhost:7687
      * username/pw = neo4j/neo4j
      * CHANGE PASSWORD
  * \# sudo bloodhound
    * Database URL: bolt://127.0.0.1:7687
    * Username: neo4j
    * Password: newpassword
    *
    * Upload data - all the created csv files
  * Neo4j allows for raw queries through its own language called Cypher
    * [https://blog.cptjesus/posts/introtocypher](https://blog.cptjesus/posts/introtocypher)
    * [https://porterhau5.com/blog/extending-bloodhound-track-and-visualize-your-compromise](https://porterhau5.com/blog/extending-bloodhound-track-and-visualize-your-compromise)
    * [https://github.com/porterhau5/BloodHound-Owned/blob/master/customqueries.json](https://github.com/porterhau5/BloodHound-Owned/blob/master/customqueries.json)
  * When using the ACL method, bloodhound will gather all permissions for users/objects
  * The info we gather from Access Control Entries describes allowed and denied permissions for users groups and comps.
  * Bloodhound 1.3 - the ACL attack path Update [https://wald0.com/?p=112](https://wald0.com/?p=112)
  * Introducing the adversary resiliancy methodology [http://bit.ly/2GYU7S7](http://bit.ly/2GYU7S7)

### **Offensive Tools**

* AD  reconnasaince and numeration
  * [ADExplorer by Sysinternals](https://docs.microsoft.com/en-us/sysinternals/downloads/adexplorer) - An advanced Active Directory (AD) viewer and editor. You can use AD Explorer to easily navigate an AD database, define favorite locations, view object properties and attributes without having to open dialog boxes, edit permissions, view an object's schema, and execute sophisticated searches that you can save and re-execute.
  * [ADRecon](https://github.com/adrecon/ADRecon) - ADRecon is a tool which extracts and combines various artifacts (as highlighted below) out of an AD environment.
  * [ACLight](https://github.com/cyberark/ACLight) -A tool for advanced discovery of Privileged Accounts - including Shadow Admins.
  * [TruffleSnout](https://github.com/dsnezhkov/TruffleSnout) - Iterative AD discovery toolkit for offensive operators. Situational awareness and targeted low noise enumeration.
  * [Snaffler](https://github.com/SnaffCon/Snaffler) - It gets a list of Windows computers from Active Directory, then spreads out its snaffly appendages to them all to figure out which ones have file shares, and whether you can read them.
* [CrackMapExec](https://github.com/byt3bl33d3r/CrackMapExec) - CrackMapExec (a.k.a CME) is a post-exploitation tool that helps automate assessing the security of _large_ Active Directory networks. Built with stealth in mind, CME follows the concept of "Living off the Land": abusing built-in Active Directory features/protocols to achieve it's functionality and allowing it to evade most endpoint protection/IDS/IPS solutions.
  * [Home Â· byt3bl33d3r/CrackMapExec Wiki Â· GitHub](https://github.com/byt3bl33d3r/CrackMapExec/wiki)&#x20;
  * [Introduction - CrackMapExec \~ CME WIKI](https://mpgn.gitbook.io/crackmapexec/)
* [LAPSToolkit](https://github.com/leoloobeek/LAPSToolkit) - Tool to audit and attack LAPS environments.
* [Powermad](https://github.com/Kevin-Robertson/Powermad) - PowerShell MachineAccountQuota and DNS exploit tools
  * [https://www.netspi.com/blog/technical/network-penetration-testing/exploiting-adidns/](https://www.netspi.com/blog/technical/network-penetration-testing/exploiting-adidns/)
* [https://xapax.github.io/security/#attacking\_active\_directory\_domain/good\_to\_know/tools/](https://xapax.github.io/security/#attacking\_active\_directory\_domain/good\_to\_know/tools/)

### Defensive/Hardening Tools

* [PingCastle](https://www.pingcastle.com) - A tool designed to assess quickly the Active Directory security level with a methodology based on risk assessment and a maturity framework
* [Aorato Skeleton Key Malware Remote DC Scanner](https://gallery.technet.microsoft.com/Aorato-Skeleton-Key-24e46b73) - Remotely scans for the existence of the Skeleton Key Malware
* [RiskySPN](https://github.com/cyberark/RiskySPN) - RiskySPNs is a collection of PowerShell scripts focused on detecting and abusing accounts associated with SPNs (Service Principal Name).
* [Deploy-Deception](https://github.com/samratashok/Deploy-Deception) - A PowerShell module to deploy active directory decoy objects
* [SpoolerScanner](https://github.com/vletoux/SpoolerScanner) - Check if MS-RPRN is remotely available with powershell/c#
* [dcept](https://github.com/secureworks/dcept) - A tool for deploying and detecting use of Active Directory honeytokens
* [DCSYNCMonitor](https://github.com/shellster/DCSYNCMonitor) - Monitors for DCSYNC and DCSHADOW attacks and create custom Windows Events for these events
* [jackdaw](https://github.com/skelsec/jackdaw) - Jackdaw is here to collect all information in your domain, store it in a SQL database and show you nice graphs on how your domain objects interact with each-other an how a potential attacker may exploit these interactions. It also comes with a handy feature to help you in a password-cracking project by storing/looking up/reporting hashes/passowrds/users.

{% content-ref url="../../../blue-defense/device-hardening/ad-security-checks.md" %}
[ad-security-checks.md](../../../blue-defense/device-hardening/ad-security-checks.md)
{% endcontent-ref %}

## **AD Certificate Services**

{% embed url="https://docs.microsoft.com/en-us/learn/modules/implement-manage-active-directory-certificate-services" %}

* [Certify](https://github.com/GhostPack/Certify) - Certify is a C# tool to enumerate and abuse misconfigurations in Active Directory Certificate Services (AD CS).
  * [https://specterops.io/assets/resources/Certified\_Pre-Owned.pdf](https://specterops.io/assets/resources/Certified\_Pre-Owned.pdf)
  * [Certipy](https://github.com/ollypwn/Certipy) - Python implementation for Certify
  * [https://research.ifcr.dk/certipy-2-0-bloodhound-new-escalations-shadow-credentials-golden-certificates-and-more-34d1c26f0dc6?gi=8b97d28018d8](https://research.ifcr.dk/certipy-2-0-bloodhound-new-escalations-shadow-credentials-golden-certificates-and-more-34d1c26f0dc6?gi=8b97d28018d8)
* [PSPKIAudit](https://github.com/GhostPack/PSPKIAudit) - PowerShell toolkit for auditing Active Directory Certificate Services (AD CS).
* [https://www.exandroid.dev/2021/06/23/ad-cs-relay-attack-practical-guide/](https://www.exandroid.dev/2021/06/23/ad-cs-relay-attack-practical-guide/)

## **AD Enumeration**

* [https://attl4s.github.io/assets/pdf/Understanding\_Active\_Directory\_Enumeration.pdf](https://attl4s.github.io/assets/pdf/Understanding\_Active\_Directory\_Enumeration.pdf)

{% content-ref url="../enumeration-and-harvesting/" %}
[enumeration-and-harvesting](../enumeration-and-harvesting/)
{% endcontent-ref %}

## **AD Credential Harvesting**

{% content-ref url="../enumeration-and-harvesting/ad-remote-harvesting.md" %}
[ad-remote-harvesting.md](../enumeration-and-harvesting/ad-remote-harvesting.md)
{% endcontent-ref %}

## **AD Privilege Escalation**

{% content-ref url="ad-privilege-escalation.md" %}
[ad-privilege-escalation.md](ad-privilege-escalation.md)
{% endcontent-ref %}

## **AD Persistence**

{% content-ref url="../persistence.md" %}
[persistence.md](../persistence.md)
{% endcontent-ref %}

## Special AD Targets

### Microsoft SQL Server

* [How to get SQL Server Sysadmin Privileges as a Local Admin with PowerUpSQL](https://blog.netspi.com/get-sql-server-sysadmin-privileges-local-admin-powerupsql/)
* [Compromise With Powerupsql â€“ Sql Attacks](https://blog.stealthbits.com/compromise-with-powerupsql-sql-attacks/)

### Red Forest

* [Attack and defend Microsoft Enhanced Security Administrative](https://download.ernw-insight.de/troopers/tr18/slides/TR18\_AD\_Attack-and-Defend-Microsoft-Enhanced-Security.pdf)

### Exchange

* [Exchange-AD-Privesc](https://github.com/gdedrouas/Exchange-AD-Privesc)
* [Abusing Exchange: One API call away from Domain Admin](https://dirkjanm.io/abusing-exchange-one-api-call-away-from-domain-admin/)
* [NtlmRelayToEWS](https://github.com/Arno0x/NtlmRelayToEWS)
